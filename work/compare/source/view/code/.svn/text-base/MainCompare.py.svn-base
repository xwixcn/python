#!/usr/bin/env python
# -*- coding=utf-8 -*-
import urllib2
import sys
import hashlib
import json
import urllib
from config_agent import load_config
from Compare import *
from regressLogger import log

config = load_config( 'compare.cfg' )
proxy_Handle = urllib2.ProxyHandler( {"http": "http://172.20.23.205:80"} )
opener = urllib2.build_opener( proxy_Handle )
urllib2.install_opener( opener )
class MainCompare():
    
    def __init__( self ):
        self.data_sevices_url = config.get( '公共配置', '接收问句地址' )
        self.post_sevices_url = config.get( '公共配置', '发送结果地址' )


    def getCases( self ):
        '''
                获取case数据
        '''
        try:
            data = urllib2.urlopen( self.data_sevices_url ).read()
            cases = json.loads( data )["name"]
            print len( cases )
            return 0, cases
        except urllib2.HTTPError:
            errorMsg = "get cases encount HTTPError, %s" % sys.exc_info()[0]
            log.error( "sorry,can't receive data ,reason:%s" % ( errorMsg ) )
            return 1, errorMsg
        except urllib2.URLError:
            errorMsg = "get cases encount URLError, %s" % sys.exc_info()[0]
            log.error( "sorry,can't receive data ,reason:%s" % ( errorMsg ) )
            return 1, errorMsg
            
     
    def _getRoundInfo( self ):
        round_info = 1
        return round_info

    def getMultiCompareResult( self ):
        '''
        获取比对结果
        '''
        case_result = {}
        #if status is 1, cases is a string of errMsg
        ( status, cases ) = self.getCases()
        if status == 1:
            case_result["errMsg"] = cases
        elif status == 0:
            case_result = Multicompare( cases )
        return case_result 
    
    
    def getSingleCompareResult( self ):
        
        '''
                获取比对结果
        '''
        case_result = {}
        #if status is 1, cases is a string of errMsg
        ( status, cases ) = self.getCases()
        if status == 1:
            case_result["errMsg"] = cases
        elif status == 0:
            case_result = SingleCompare( cases )
        return case_result 


    def postData( self , flag ):
        '''
        post Data
        '''
        if flag == 0:
            resultdata = self.getSingleCompareResult()
        elif flag == 1:
            resultdata = self.getMultiCompareResult()
        else:
            sys.exit( 1 )
        resultdata = urllib.urlencode( resultdata )
        print resultdata
        headers = {"Accept":"application/json", "Content-Type":"application/x-www-form-urlencoded"}
        req = urllib2.Request( url = self.post_sevices_url, data = "%s" % ( resultdata ), headers = headers )
        
        try:
            print urllib2.urlopen( req ).read()
        except urllib2.HTTPError, e:
            print e
            log.error( "sorry,can't post data ,reason:%s" % ( str( e ) ) )
            sys.exit( 1 )
        except urllib2.URLError, e:
            print e
            log.error( "sorry,can't post data ,reason:%s" % ( str( e ) ) )
            sys.exit( 1 )

        
     
if __name__ == "__main__":
    main = MainCompare()
    print main.postData( 0 )
       
